{% extends "layout.html" %}
{% block content %}
<script src="/static/datepicker/js/bootstrap-datepicker.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<link href="/static/datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet" type="text/css" />
<link href="/static/my-theme/css/index.css" rel="stylesheet" type="text/css" />
<div class="row mt-5">
    <div class="col-md-6 p-4 border">
        <form id="search-form">
            <p class="h5">파일 타입</p>
            <div class="mb-4">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="type" id="malware" value="malware" checked/>
                    <label class="form-check-label" for="malware">악성</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="type" id="benign" value="benign" />
                    <label class="form-check-label" for="benign">정상</label>
                </div>
            </div>
            <p class="h5">수집 채널</p>
            <div class="mb-4">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="channel" id="virussign" value="virussign">
                    <label class="form-check-label" for="virussign">Virus Sign</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="channel" id="virusshare" value="virusshare">
                    <label class="form-check-label" for="virusshare">Virus Share</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="channel" id="kisa" value="kisa">
                    <label class="form-check-label" for="kisa">KISA</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="channel" id="benign-crawling" value="benign-crawling" disabled>
                    <label class="form-check-label" for="benign-crawling">정상 크롤링</label>
                </div>
            </div>
            <hr/>
            <p class="h5">백신 회사</p>
            <div class="mb-4">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="vaccine-company" id="kaspersky" value="kaspersky" checked/>
                    <label class="form-check-label" for="kaspersky">카스퍼스키</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="vaccine-company" id="bitdefender" value="bitdefender" />
                    <label class="form-check-label" for="bitdefender">BitDefender</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="vaccine-company" id="symantec" value="symantec" />
                    <label class="form-check-label" for="symantec">시만텍</label>
                </div>
            </div>
            <p class="h5">라벨 필터링</p>
            <div class="form-group mb-4">
                <input class="form-control" type="text" id="label" name="label">
            </div>
            <hr/>
            <p class="h5">수집 기간</p>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="date-all" checked/>
                <label class="form-check-label" for="date-all">모든 기간</label>
            </div>
            <div class="collected-range row mx-0 mb-4">
                <div class="col-5 col-md-5 mx-0 px-0">
                    <input id="start-collected" name="start-collected" class="form-control input-date" autocomplete="off" disabled/>
                </div>
                <div class="col-2 col-md-2 mx-0 px-0 text-center">
                    <label class="">~</label>
                </div>
                <div class="col-5 col-md-5 mx-0 px-0">
                    <input id="end-collected" name="end-collected" class="form-control input-date" autocomplete="off" disabled/>
                </div>
            </div>
            <p class="h5">파일 갯수</p>
            <div class="form-check">
                <input type="checkbox" id="get-all" class="form-check-input" checked/>
                <label class="form-check-label" for="get-all">모두 가져오기</label>
            </div>
            <div class="form-row align-items-center mb-3">
                <div class="col-4">
                    <input type="number" class="form-control" id="limit" name="limit" disabled>
                </div>
            </div>
            <hr/>
            <button type="button" class="btn btn-primary float-right" id="search">검색</button>
        </form>
    </div>
    <div class="col-md-5 offset-md-1 d-flex flex-column p-4 border">
        <h4 class="mb-4">최근 검색 결과 (최대 10건)</h4>
        <div class="border result-preview-wrapper mb-2 p-3">
            <div class="row mx-0 mb-2">
                <div class="col px-4">검색 시각</div>
                <div class="col"><span class="float-right">상태</span></div>
            </div>
            <ul class="query_list"></ul>
        </div>
    </div>
    <div class="col-md-12 mt-3">
        <span class="float-right">
            <a href="https://github.com/Junnyung-Heo/seclab_ftpclient">전용 FTP Client 다운받기</a>
        </span>
    </div>
</div>

<script>
    $(document).ready(function(){
        $('#start-collected').datepicker({
            uiLibrary: 'bootstrap4',
            format: 'yyyy-mm-dd'
        });
        $('#end-collected').datepicker({
            uiLibrary: 'bootstrap4',
            format: 'yyyy-mm-dd'
        });
        $('input[name=type]').click(function(){
            var radioValue = $(this).val();
            if(radioValue == 'benign'){
                $('#benign-crawling').prop("disabled", false);
                $('input[name=vaccine-company]').attr("disabled", true);
                $('#label').prop("disabled", true);
            }
            else{
                $('#benign-crawling').prop("checked", false);
                $('#benign-crawling').prop("disabled", true);
                $('input[name=vaccine-company]').attr("disabled", false);
                $('#label').prop("disabled", false);
            }
        });
        $('#date-all').click(function(){
            var isChecked = $(this).prop('checked');
            if(isChecked){
                $('#start-collected').prop("disabled", true);
                $('#end-collected').prop("disabled", true);
            }
            else{
                $('#start-collected').prop("disabled", false);
                $('#end-collected').prop("disabled", false);
            }
        });
        $('#get-all').click(function(){
            if($('#limit').attr("disabled") == "disabled"){
                $('#limit').prop("disabled", false);
            }
            else{
                $('#limit').prop("disabled", true);
            }
        });
        $('#start-collected').change(function(){
            var start_date = $('#start-collected').val()
            var end_date = $('#end-collected').val()
            if (start_date==''){
                $('#end-collected').val('');
                return
            }
            if (end_date!='' && start_date>end_date){
                $(this).val('');
                $('#end-collected').val('');
                alert('종료일보다 늦습니다');
            }
        })
        $('#end-collected').change(function(){
            var start_date = $('#start-collected').val()
            var end_date = $('#end-collected').val()
            if (end_date==''){
                $('#start-collected').val('');
                return
            }
            if (start_date==''){
                $(this).val('');
                alert('시작일을 선택해주세요');
            } else if (start_date>end_date){
                $(this).val('');
                alert('시작일보다 빠릅니다');
            }
        })

        function checkForm(){
            if(!$('input:checkbox[name=channel]').is(':checked')){
                return false;
            }
            if(!$('#date-all').prop('checked') && ($('#start-collected').val() == '' || $('#end-collected').val() == '')){
                return false;
            }
            if(!$('#get-all').prop('checked') && ($('#limit').val() == '' || parseInt($('#limit').val())<1 )){
                return false;
            }
            return true;
        }

        function loadQueries(){
            $.ajax({
                url:'/queries',
                type:'get',
                success: function(data){
                    var res = $.parseJSON(data);
                    $('.query_list').children().remove()
                    res.forEach(function(item, index, array){
                        list_element = '<li class="mb-2"><div class="row mx-0 clearfix align-items-center">';
                        list_element += '<div class="col">'+item.query_created_at+'</div>'
                        if(item.query_status == '0'){
                            list_element += '<div class="col"><div class="spinner-border text-primary float-right" role="status">\
                            </div><span class="float-right mr-3">검색 중</span></div>'
                        }
                        else if(item.query_status == '1'){
                            list_element += '<div class="col"><i class="fas fa-check text-success fa-2x float-right"></i>'
                            list_element += '<button id='+item.query_id+' class="btn btn-primary btn-sm float-right mr-2">다운로드</button></div>'
                        }
                        else if(item.query_status == '2'){
                            list_element += '<span class="col"><i class="fas fa-exclamation-circle text-danger fa-2x float-right"></i></span>'
                        }
                        list_element += '</div></li>';
                        $('.query_list').append(list_element)
                        $('#'+item.query_id).click(function(){downloadQuery(this)});
                    })
                }
            })
        }

        $('#search').click(function(){
            if(!checkForm()){
                alert('빈 칸을 채워주세요');
                return
            }
            socket.emit('search', getFormData($('#search-form')))
        })

        function getFormData(form){
            var o = {};
            var a = form.serializeArray();
            $.each(a, function() {
                if (o[this.name]) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function downloadQuery(element){
            var qid = $(element).attr('id');
            window.location='/queries/'+qid
        }

        // Setup socketio functions
        var namespace = '/socket'; // change to an empty string to use the global namespace
        var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

        socket.on('pending_exist', function() {
            alert('아직 진행중인 쿼리가 있습니다');
        });
        socket.on('query_start', function() {
            loadQueries()
        });
        socket.on('query_success', function() {
            sleep(500).then(()=>{
                loadQueries()
            });
        });
        socket.on('query_failed', function() {
            loadQueries()
        });

        loadQueries();
     });
</script>

{% endblock %}