{% extends "layout.html" %}
{% block content %}
<script src="/static/datepicker/js/bootstrap-datepicker.min.js" type="text/javascript"></script>
<link href="/static/datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet" type="text/css" />
<link href="/static/my-theme/css/index.css" rel="stylesheet" type="text/css" />
<div class="row" style="margin-top:80px;">
    <div class="col-md-6 p-4 border mr-3">
        <form id="search-form">
            <div>
                <label>수집 채널 선택</label>
            </div>
            <div class="form-group form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="channel" id="virussign" value="virussign">
                <label class="form-check-label" for="virussign">Virus Sign</label>
            </div>
            <div class="form-group form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="channel" id="virusshare" value="virusshare">
                <label class="form-check-label" for="virusshare">Virus Share</label>
            </div>
            <div class="form-group form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="channel" id="kisa" value="kisa">
                <label class="form-check-label" for="kisa">KISA</label>
            </div>
            <div>
                <label>수집 기간 선택</label>
            </div>
            <div class="form-inline mb-3">
                <div class="form-group">
                    <input id="start-collected" name="start-collected" class="form-control input-date"/>
                </div>
                <div class="form-group">
                    <label class="mx-3">~</label>
                </div>
                <div class="form-group">
                    <input id="end-collected" name="end-collected" class="form-control input-date" />
                </div>
            </div>
            <div>
                <label>백신 회사 선택</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="label-company" id="kaspersky" value="kaspersky" checked/>
                <label class="form-check-label" for="kaspersky">카스퍼스키</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="label-company" id="bitdefender" value="bitdefender" />
                <label class="form-check-label" for="bitdefender">BitDefender</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="label-company" id="symantec" value="symantec" />
                <label class="form-check-label" for="symantec">시만텍</label>
            </div>
            <div class="form-check form-check-inline mb-4">
                <input class="form-check-input" type="radio" name="label-company" id="all-benign" value="all-benign" />
                <label class="form-check-label" for="all-benign">모두 정상</label>
            </div>
            <div class="form-group">
                <label for="label">라벨 필터링</label>
                <input class="form-control" type="text" id="label" name="label">
            </div>
            <div class="form-inline mb-3">
                <div class="form-group mr-3">
                    <label for="limit">가져올 갯수</label>
                </div>
                <div class="form-group">
                    <input type="number" class="form-control" id="limit" name="limit" value="1">
                </div>
            </div>
            <button type="button" class="btn btn-primary float-right" id="search">검색</button>
        </form>
    </div>
    <div class="col-md-5 d-flex flex-column p-4 border">
        <h4 class="mb-4">최근 검색 결과 (최대 10건)</h4>
        <div class="border result-preview-wrapper mb-2 p-3">
            <div class="row mx-0 mb-2">
                <div class="col px-4">검색시간</div>
                <div class="col"><span class="float-right">상태</span></div>
            </div>
            <ul class="query_list"></ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function(){
        $('#start-collected').datepicker({
            uiLibrary: 'bootstrap4',
            format: 'yyyy-mm-dd'
        });
        $('#end-collected').datepicker({
            uiLibrary: 'bootstrap4',
            format: 'yyyy-mm-dd'
        });
        $('input[name=label-company]').click(function(){
            var radioValue = $(this).val();
            if(radioValue == 'all-benign'){
                $('#label').prop("disabled", true);
            }
            else{
                $('#label').prop("disabled", false);
            }
        });
        $('#start-collected').change(function(){
            var start_date = $('#start-collected').val()
            var end_date = $('#end-collected').val()
            if (start_date==''){
                $('#end-collected').val('');
                return
            }
            if (end_date!='' && start_date>end_date){
                $(this).val('');
                $('#end-collected').val('');
                alert('종료일보다 늦습니다');
            }
        })
        $('#end-collected').change(function(){
            var start_date = $('#start-collected').val()
            var end_date = $('#end-collected').val()
            if (end_date==''){
                $('#start-collected').val('');
                return
            }
            if (start_date==''){
                $(this).val('');
                alert('시작일을 선택해주세요');
            } else if (start_date>end_date){
                $(this).val('');
                alert('시작일보다 빠릅니다');
            }
        })

        function checkForm(){
            if(!$('input:checkbox[name=channel]').is(':checked')){
                return false;
            }
            if($('#start-collected').val() == '' || $('#end-collected').val() == ''){
                return false;
            }
            if(!$('input:radio[name=label-company]').is(':checked')){
                return false;
            }
            if($('#limit').val() == ''){
                return false;
            }
            if(parseInt($('#limit').val())<1){
                return false;
            }
            return true;
        }

        function loadQueries(){
            $.ajax({
                url:'/queries',
                type:'get',
                success: function(data){
                    var res = $.parseJSON(data);
                    $('.query_list').children().remove()
                    res.forEach(function(item, index, array){
                        list_element = '<li class="mb-2"><div class="row mx-0 clearfix align-items-center">';
                        list_element += '<div class="col">'+item.query_created_at+'</div>'
                        if(item.query_status == '0'){
                            list_element += '<div class="col"><div class="spinner-border text-primary float-right" role="status">\
                            </div><span class="float-right mr-3">검색 중</span></div>'
                        }
                        else if(item.query_status == '1'){
                            list_element += '<div class="col"><i class="fas fa-check text-success fa-2x float-right"></i>'
                            list_element += '<button class="btn btn-primary btn-sm float-right mr-2">다운로드</button></div>'
                        }
                        else if(item.query_status == '2'){
                            list_element += '<span class="col"><i class="fas fa-exclamation-circle text-danger fa-2x float-right"></i></span>'
                        }
                        list_element += '</div></li>';
                        $('.query_list').append(list_element)
                    })
                }
            })
        }

        $('#search').click(function(){
            $.ajax({
                url:'/search',
                type:'post',
                data:$('#search-form').serialize(),
                beforeSend: function(xhr,opts){
                    if(!checkForm()){
                        alert('빈 칸을 채워주세요');
                        xhr.abort();
                    }
                },
                error: function(res){
                    if(res.responseText == 'last query is running'){
                        alert('이전 쿼리가 아직 진행중입니다');
                    }
                },
                success: function(msg){
                    if(msg == 'ok'){
                        loadQueries();
                    }
                }
            })
        })

        loadQueries();

     });
</script>

{% endblock %}